#!/usr/bin/env python3
"""
FTP Client - Консольный FTP-клиент
Автор: Kanin
Версия: 1.0

Простой FTP-клиент с интерактивным консольным интерфейсом.
Позволяет подключаться к FTP-серверам, просматривать файлы,
скачивать и загружать файлы, управлять директориями.
"""

# Импорт необходимых модулей
from ftplib import FTP  # Основной модуль для работы с FTP
import os               # Для работы с файловой системой
import sys              # Для системных функций


class ConsoleFTPClient:
    """
    Основной класс консольного FTP-клиента.
    Управляет подключением к серверу и предоставляет интерфейс для пользователя.
    """
    
    def __init__(self):
        """
        Инициализация клиента.
        Создает начальное состояние - клиент не подключен к серверу.
        """
        self.ftp = None          # Объект FTP-соединения (будет создан при подключении)
        self.connected = False   # Флаг подключения (True если подключен к серверу)
        self.host = ''           # Адрес FTP-сервера
    
    def run(self):
        """
        Основной метод запуска клиента.
        Выводит меню и обрабатывает выбор пользователя в бесконечном цикле.
        """
        while True:
            # Вывод заголовка меню
            print("\n" + "="*50)
            print("FTP КЛИЕНТ")
            print("="*50)
            
            # В зависимости от состояния подключения показываем разные меню
            if not self.connected:
                # Меню для неподключенного состояния
                print("1. Подключиться к FTP-серверу")
                print("0. Выход")
            else:
                # Меню для подключенного состояния
                print(f"Подключено к: {self.host}")
                print("2. Просмотреть файлы")
                print("3. Скачать файл")
                print("4. Загрузить файл")
                print("5. Создать директорию")
                print("6. Удалить файл")
                print("7. Сменить директорию")
                print("8. Текущая директория")
                print("9. Отключиться")
                print("0. Выход")
            
            # Запрос выбора пользователя
            choice = input("\nВыберите действие: ")
            
            # Обработка выхода из программы
            if choice == '0':
                if self.connected:
                    self.disconnect()  # Отключаемся от сервера перед выходом
                print("Выход...")
                break  # Прерываем цикл и завершаем программу
            
            # Маршрутизация выбора в зависимости от состояния подключения
            if not self.connected:
                if choice == '1':
                    self.connect_menu()  # Показать меню подключения
                else:
                    print("Неверный выбор")  # Некорректный ввод
            else:
                # Обработка команд для подключенного состояния
                if choice == '2':
                    self.list_files_menu()      # Просмотр файлов
                elif choice == '3':
                    self.download_menu()        # Скачивание файла
                elif choice == '4':
                    self.upload_menu()          # Загрузка файла
                elif choice == '5':
                    self.create_dir_menu()      # Создание директории
                elif choice == '6':
                    self.delete_menu()          # Удаление файла
                elif choice == '7':
                    self.change_dir_menu()      # Смена директории
                elif choice == '8':
                    self.show_current_dir()     # Показать текущую директорию
                elif choice == '9':
                    self.disconnect()           # Отключиться от сервера
                else:
                    print("Неверный выбор")     # Некорректный ввод
    
    def connect_menu(self):
        """
        Меню подключения к FTP-серверу.
        Запрашивает у пользователя данные для подключения и устанавливает соединение.
        """
        print("\n--- Подключение к FTP ---")
        
        # Запрос данных для подключения
        self.host = input("Адрес сервера: ")  # Например: ftp.example.com или IP-адрес
        # Имя пользователя (по умолчанию 'anonymous' для анонимного доступа)
        username = input("Имя пользователя (anonymous): ") or 'anonymous'
        password = input("Пароль: ") or ''  # Пароль (пустой для анонимного доступа)
        
        try:
            # Создаем объект FTP-соединения
            self.ftp = FTP()
            
            # Устанавливаем соединение с сервером
            print(f"Подключаемся к {self.host}...")
            self.ftp.connect(self.host, timeout=10)  # timeout=10 секунд
            
            # Авторизация на сервере
            self.ftp.login(username, password)
            
            # Вывод информации об успешном подключении
            print(f"Успешно подключились!")
            # getwelcome() возвращает приветственное сообщение сервера
            print(f"Приветственное сообщение: {self.ftp.getwelcome()}")
            
            # Устанавливаем флаг подключения
            self.connected = True
            
        except Exception as e:
            # Обработка ошибок подключения
            print(f"Ошибка подключения: {e}")
            self.connected = False  # Сбрасываем флаг при ошибке
    
    def disconnect(self):
        """
        Отключение от FTP-сервера.
        Закрывает соединение корректным образом.
        """
        if self.ftp:
            self.ftp.quit()         # Отправляем команду QUIT серверу
            self.connected = False  # Сбрасываем флаг подключения
            print("Отключились от сервера")
    
    def list_files_menu(self):
        """
        Меню просмотра файлов и директорий на сервере.
        Показывает содержимое указанной директории.
        """
        # Запрос директории для просмотра (пустая строка = текущая директория)
        directory = input("Директория (нажмите Enter для текущей): ")
        
        try:
            # Выводим заголовок с именем директории
            print(f"\nСодержимое {directory or 'текущей директории'}:")
            
            # Список для хранения информации о файлах
            files = []
            
            # dir() получает список файлов и добавляет каждый элемент в список files
            # Второй параметр - функция обратного вызова для каждого элемента
            self.ftp.dir(directory, files.append)
            
            # Вывод всех файлов и директорий
            for file in files:
                print(file)
                
        except Exception as e:
            # Обработка ошибок при получении списка файлов
            print(f"Ошибка: {e}")
    
    def download_menu(self):
        """
        Меню скачивания файла с сервера.
        Загружает файл с FTP-сервера на локальный компьютер.
        """
        # Запрос имени файла на сервере
        remote_file = input("Имя файла на сервере: ")
        
        # Запрос локального имени файла (по умолчанию = имя файла на сервере)
        local_file = input("Локальное имя файла (нажмите Enter для того же имени): ")
        
        # Если пользователь не ввел локальное имя, используем имя файла с сервера
        if not local_file:
            # os.path.basename() извлекает имя файла из полного пути
            local_file = os.path.basename(remote_file)
        
        try:
            # Открываем локальный файл для записи в бинарном режиме ('wb')
            with open(local_file, 'wb') as f:
                # retrbinary() скачивает файл с сервера
                # 'RETR remote_file' - FTP-команда для скачивания файла
                # f.write - функция, которая записывает полученные данные в файл
                self.ftp.retrbinary(f'RETR {remote_file}', f.write)
            
            # Вывод сообщения об успешном скачивании
            print(f"Файл {remote_file} скачан как {local_file}")
            
        except Exception as e:
            # Обработка ошибок скачивания
            print(f"Ошибка при скачивании: {e}")
    
    def upload_menu(self):
        """
        Меню загрузки файла на сервер.
        Отправляет локальный файл на FTP-сервер.
        """
        # Запрос пути к локальному файлу
        local_file = input("Локальный файл для загрузки: ")
        
        # Проверка существования локального файла
        if not os.path.exists(local_file):
            print("Файл не найден")
            return  # Прерываем выполнение если файл не существует
        
        # Запрос имени файла на сервере
        remote_file = input("Имя файла на сервере (нажмите Enter для того же имени): ")
        
        # Если пользователь не ввел имя, используем имя локального файла
        if not remote_file:
            remote_file = os.path.basename(local_file)
        
        try:
            # Открываем локальный файл для чтения в бинарном режиме ('rb')
            with open(local_file, 'rb') as f:
                # storbinary() загружает файл на сервер
                # 'STOR remote_file' - FTP-команда для загрузки файла
                # f - файловый объект для чтения данных
                self.ftp.storbinary(f'STOR {remote_file}', f)
            
            # Вывод сообщения об успешной загрузке
            print(f"Файл {local_file} загружен как {remote_file}")
            
        except Exception as e:
            # Обработка ошибок загрузки
            print(f"Ошибка при загрузке: {e}")
    
    def create_dir_menu(self):
        """
        Меню создания новой директории на сервере.
        Создает директорию с указанным именем.
        """
        # Запрос имени новой директории
        dir_name = input("Имя новой директории: ")
        
        try:
            # mkd() создает новую директорию на сервере
            self.ftp.mkd(dir_name)
            
            # Вывод сообщения об успешном создании
            print(f"Директория {dir_name} создана")
            
        except Exception as e:
            # Обработка ошибок создания директории
            print(f"Ошибка: {e}")
    
    def delete_menu(self):
        """
        Меню удаления файла с сервера.
        Удаляет указанный файл после подтверждения пользователя.
        """
        # Запрос имени файла для удаления
        filename = input("Имя файла для удаления: ")
        
        # Запрос подтверждения удаления (защита от случайного удаления)
        confirm = input(f"Удалить {filename}? (y/n): ")
        
        # Проверка подтверждения
        if confirm.lower() == 'y':
            try:
                # delete() удаляет файл на сервере
                self.ftp.delete(filename)
                
                # Вывод сообщения об успешном удалении
                print(f"Файл {filename} удален")
                
            except Exception as e:
                # Обработка ошибок удаления
                print(f"Ошибка: {e}")
    
    def change_dir_menu(self):
        """
        Меню смены текущей рабочей директории на сервере.
        Переходит в указанную директорию.
        """
        # Запрос новой директории
        directory = input("Новая директория: ")
        
        try:
            # cwd() изменяет текущую рабочую директорию
            self.ftp.cwd(directory)
            
            # pwd() возвращает текущую директорию
            print(f"Перешли в директорию: {self.ftp.pwd()}")
            
        except Exception as e:
            # Обработка ошибок смены директории
            print(f"Ошибка: {e}")
    
    def show_current_dir(self):
        """
        Показывает текущую рабочую директорию на сервере.
        """
        try:
            # pwd() возвращает текущую директорию
            print(f"Текущая директория: {self.ftp.pwd()}")
            
        except Exception as e:
            # Обработка ошибок получения текущей директории
            print(f"Ошибка: {e}")


# Точка входа в программу
if __name__ == "__main__":
    # Создаем экземпляр клиента
    client = ConsoleFTPClient()
    # Запускаем основной цикл
    client.run()